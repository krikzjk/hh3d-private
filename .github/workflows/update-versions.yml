name: Update versions.json

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  update-versions:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Update versions.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          # Lấy tag (v3.5.2 -> 3.5.2)
          TAG="${GITHUB_REF##*/}"
          TAG="${TAG#v}"

          echo "Version: $TAG"

          # Đợi asset .zip xuất hiện (tối đa ~30s)
          URL=""
          for i in {1..10}; do
            URL=$(curl -s \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/v$TAG \
              | jq -r '.assets[] | select(.name | endswith(".zip")) | .browser_download_url' \
              | head -n 1)

            if [ -n "$URL" ] && [ "$URL" != "null" ]; then
              break
            fi

            echo "Waiting for release asset (.zip)..."
            sleep 3
          done

          if [ -z "$URL" ] || [ "$URL" = "null" ]; then
            echo "::error::Release asset .zip not found"
            exit 1
          fi

          echo "Download URL: $URL"

          FILE=versions.json
          [ ! -f "$FILE" ] && echo "{}" > "$FILE"

          # Update JSON
          jq --arg v "$TAG" --arg url "$URL" \
            '. + {($v): {version: $v, url: $url}}' \
            "$FILE" > tmp.json && mv tmp.json "$FILE"

          echo "Updated versions.json:"
          cat "$FILE"

      - name: Commit & push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add versions.json
          git diff --staged --quiet || git commit -m "Update versions.json for v$TAG"
          git push origin HEAD:main
